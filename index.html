<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å–é…’ç³»çµ±</title>
<style>
body { font-family: Arial; background:#f5f6fa; padding:20px; }
h2 { margin-bottom:10px; }
input, button { font-size:16px; padding:8px; }
button { cursor:pointer; }
.table { width:100%; border-collapse:collapse; margin-top:15px; }
.table th, .table td { border:1px solid #ccc; padding:8px; text-align:center; }
.table th { background:#eee; }
.action-btn { background:#2c3e50; color:#fff; border:none; }
.action-btn:hover { background:#34495e; }
</style>
</head>

<body>

<h2>ğŸ¾ å­˜é…’å–ç”¨</h2>

<label>å®¢æˆ¶æ‰‹æ©Ÿï¼š</label>
<input id="phone" placeholder="09xxxxxxxx">
<button onclick="query()">æŸ¥è©¢</button>

<table class="table" id="resultTable" style="display:none;">
<thead>
<tr>
<th>å®¢æˆ¶</th>
<th>é…’å“</th>
<th>å‰©é¤˜</th>
<th>åˆ°æœŸæ—¥</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="resultBody"></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz2ID5AezUOo-ujdHz9lK_QefSfKi50ZJh1vhBkjPmsGXhk3pKiVcvblMc7gXfdyi8GnA/exec";

async function query(){
  const phone = document.getElementById("phone").value.trim();
  if(!phone){ alert("è«‹è¼¸å…¥æ‰‹æ©Ÿ"); return; }

  const res = await fetch(`${API_URL}?action=queryStoredWine&phone=${phone}`);
  const data = await res.json();

  if(data.data.length === 0){
    alert("æŸ¥ç„¡å­˜é…’");
    return;
  }

  const body = document.getElementById("resultBody");
  body.innerHTML = "";

  data.data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.customerName}</td>
      <td>${r.productName}</td>
      <td>${r.remainQty} ${r.unit}</td>
      <td>${r.expireDate}</td>
      <td>
        <button class="action-btn"
          onclick="take('${r.storedId}',${r.remainQty})">å–é…’</button>
      </td>
    `;
    body.appendChild(tr);
  });

  document.getElementById("resultTable").style.display="table";
}

async function take(storedId, remain){
  const qty = prompt(`è¼¸å…¥å–ç”¨é‡ï¼ˆå‰©é¤˜ ${remain}ï¼‰`);
  if(!qty) return;
  if(Number(qty) <= 0 || Number(qty) > remain){
    alert("å–ç”¨é‡éŒ¯èª¤");
    return;
  }

  const payload = {
    storedId,
    takeQty: Number(qty),
    operator: "æ«ƒæª¯"
  };

  const res = await fetch(`${API_URL}?action=takeStoredWine`,{
    method:"POST",
    body:JSON.stringify(payload)
  });

  const data = await res.json();
  if(data.status==="success"){
    alert("å–é…’å®Œæˆ");
    query();
  } else {
    alert("å–é…’å¤±æ•—");
  }
}
</script>

</body>
</html>
